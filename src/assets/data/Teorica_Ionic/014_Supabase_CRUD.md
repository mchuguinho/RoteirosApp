# **Supabase - CRUD**

_Última atualização do doc. 18.Mai.2024_            

- [Supabase](#supabase)
- [Preparar a app](#preparar-a-app)
- [Desenvolver um Service](#desenvolver-um-service)
- [Desenvolver um Component](#desenvolver-um-component)
- [Construir o interface para interação com a base de dados](#construir-o-interface-para-interação-com-a-base-de-dados)

# Supabase

1. Criar uma conta no [Supabase](https://supabase.com/);
2. Criar um novo projeto em **New Project** e seguir as instruções para a criação de um novo projeto;
3. Aceder ao **SQL Editor** (_barra lateral do lado esquerdo_);
4. Aceder à opção **Create table**
5. Criar uma tabela chamada `alunos` com as colunas `id`, `nome` e `curso`:

    ```sql
    create table alunos (
      id bigint generated by default as identity primary key,
      nome text,
      curso text
    );
    ```

6. Aceder a **Project Settings** (_barra lateral do lado esquerdo_);
7. Aceder à opção **API**;
8. Copiar os valores do **URL** e de **anon public**.


# Preparar a app

1. Criar a app

    ```
    ionic start exemplosupabase blank --type=angular
    ```

2. Entrar na pasta do projeto Ionic e instalar o _package_ `@supabase/supabase-js`

    ```
    npm i @supabase/supabase-js
    ```   

# Desenvolver um Service

1. Criar um service para gerir as operações CRUD com o Supabase:

    ```
    ionic g service services/supabase
    ```

2. Criar o ficheiro `aluno.ts` (`\src\app\services\aluno.ts`) que servirá de apoio ao desenvolvimento do Service. Este ficheiro poderá ficar dentro da pasta `services` e apenas contém a definição do `interface` Aluno:

    ```js
    export interface Aluno {
      id?: number;
      nome: string;
      curso: string;
    }
    ```  

    > Em TypeScript, a interrogação `?` após o nome de uma propriedade indica que ela é opcional. Portanto, a declaração `id?: number;` significa que o interface (ou a classe, que não é o caso) pode ter uma propriedade chamada `id`, que é do tipo `number`, mas que não é necessária. Ou seja, uma instância pode ser criada sem definir um valor para a propriedade `id` (o que é útil para o caso em particular porque o `id`, na base de dados, é incremental e automático logo não será necessário ser especificado, por exemplo, numa operação de `INSERT`).

2. Desenvolver o código necessário para as quatro operações (**C**reate, **R**ead, **U**pdate e **D**elete) sobre a base de dados previamente criada no Supabase em `\src\app\services\supabase.service.ts`

    ```js
    import { Injectable } from '@angular/core';
    import { createClient, SupabaseClient } from '@supabase/supabase-js';
    import { Aluno } from './aluno';

    @Injectable({
      providedIn: 'root'
    })

    export class SupabaseService {

      private supabaseUrl = 'https://exemplo.co'; // URL copiado no passo acima 
      private supabaseKey = 'exemploexemplo'; // anon public copiada no passo acima;
      private supabaseClient: SupabaseClient;

      constructor() {
        this.supabaseClient = createClient(this.supabaseUrl, this.supabaseKey);
      }

      async getAlunos(): Promise<Aluno[]> {
        const { data, error } = await this.supabaseClient
          .from('alunos')
          .select('*')
          .order('nome', { ascending: true });
      
        if (error) {
          return [];
        }
      
        return data as Aluno[];
      }

      async getAlunoById(id: number): Promise<Aluno> {
        const { data, error } = await this.supabaseClient
          .from('alunos')
          .select('*')
          .eq('id', id)
          .single();

        if (error) {
          throw error;
        }

        return data as Aluno;
      }

      async insertAluno(aluno: Aluno) {
        const { data, error } = await this.supabaseClient
          .from('alunos')
          .insert(aluno)
          .single();
      
        if (error) {
          return null;
        }
        return data;
      }
      
      async updateAluno(aluno: Aluno): Promise<void> {
        const { data, error } = await this.supabaseClient
          .from('alunos')
          .update({
            nome: aluno.nome,
            curso: aluno.curso
          })
          .eq('id', aluno.id);

        if (error) {
          console.error(error);
          throw new Error('Erro ao atualizar aluno');
        }
      }
      
      async deleteAluno(id: number): Promise<void> {
        await this.supabaseClient.from('alunos').delete().eq('id', id);
      }  

    }
    ```   

# Desenvolver um Component
## _passo opcional, mas recomendado_

1. Criar um component que servirá para confirmação de operações, permitindo a resposta de confirmação "Sim/Não" em operações críticas, como por exemplo a eliminação de um registo.

    ```
    ionic g component ConfirmModal
    ```

2. Desenvolver o código necessário para o efeito pretendido. Note-se que o código é genérico o suficiente para receber um título e uma mensagem, logo pode ser utilizado em situações distintas. O código é desenvolvido no ficheiro, que resulta do comando acima, `\src\app\confirm-modal\confirm-modal.component.ts`

    ```js
    import { Component, Input } from '@angular/core';
    import { ModalController } from '@ionic/angular';

    @Component({
      selector: 'app-confirm-modal',
      template: `
        <ion-header>
          <ion-toolbar>
            <ion-title>{{ title }}</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="fecharModal(false)">Não</ion-button>
              <ion-button (click)="fecharModal(true)">Sim</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <div class="ion-padding">{{ message }}</div>
        </ion-content>
      `,
    })
    export class ConfirmModalComponent {
      @Input() message: string;
      @Input() title: string;

      constructor(private modalController: ModalController) {
        this.message = '';
        this.title = '';
      }

      async fecharModal(resposta: boolean) {
        await this.modalController.dismiss(resposta);
      }
    }
    ```

# Construir o interface para interação com a base de dados

## Considerações iniciais:

1. O **CRUD** pode ser implementado em ecrãs distintos, não obstante, neste caso em particular, foi totalmente desenvolvido no componente `home.page.ts` e no template que lhe corresponde `home.page.html`, para efeitos de simplificação da demonstração.

2. No caso de não haver a utilização de um qualquer _component_ criado para determinada finalidade, e apenas ser pretendida a interação com a base de dados Supabase, não há necessidade de qualquer configuração, quer ao nível da app, quer ao nível do component `home.page`.

3. Por outro lado, se quisermos utilizar, por exemplo, o _component_ `confirm-modal.component`, é necessária a seguinte configuração em `\src\app\home\home.module.ts` (ou no ecrã que dele faça uso):

    - Importar o _component_:

      ```js
      import { ConfirmModalComponent } from '../confirm-modal/confirm-modal.component';
      ```

    - E em `@NgModule` adicioná-lo ao array `declarations`. O referido array ficará como mostrado de seguida:

      ```js
      declarations: [HomePage, ConfirmModalComponent]
      ```

## Exemplo de `home.page.ts`

```js
import { Component } from '@angular/core';
import { Aluno } from '../services/aluno';
import { SupabaseService } from '../services/supabase.service';
import { ModalController } from '@ionic/angular';
import { ConfirmModalComponent } from '../confirm-modal/confirm-modal.component';

@Component({
  selector: 'app-home',
  templateUrl: 'home.page.html',
  styleUrls: ['home.page.scss'],
})

export class HomePage {

  alunos: Aluno[];
  aluno: Aluno;
  novoAluno = false;
  editarAluno = false;
  modalTitle: string;
  isLoadingAlunos: boolean;

  constructor(private supabaseService: SupabaseService, private modalController: ModalController) {
    this.alunos = [];
    this.modalTitle = '';
    this.aluno = {
      id: null || 0,
      nome: '',
      curso: ''
    };
    this.isLoadingAlunos = true;
  }

  async ionViewWillEnter() {
    await this.getAlunos();
  }

  async getAlunos() {
    this.isLoadingAlunos = true; 
    this.alunos = await this.supabaseService.getAlunos();
    this.isLoadingAlunos = false; 
  }

  novoAlunoForm() {
    this.aluno = {
      id: null || 0,
      nome: '',
      curso: ''
    };
    this.novoAluno = true;
    this.modalTitle = 'Novo Aluno';
  }

  editarAlunoForm(id: number) {
    this.aluno = this.alunos.find(a => a.id === id) || {id: null || 0, nome: '', curso: ''};
    this.editarAluno = true;
    this.modalTitle = `Editar aluno - ${this.aluno.nome} -`;
  }

  async setAluno() {
    if (this.novoAluno) {
      this.aluno.id = undefined;
      await this.supabaseService.insertAluno(this.aluno);
    } else if (this.editarAluno) {
      await this.supabaseService.updateAluno(this.aluno);
    }
    await this.getAlunos();
    this.fecharForms();
  }

  async removerAluno(id: number) {
    const modal = await this.modalController.create({
      component: ConfirmModalComponent,
      componentProps: {
        title: 'Confirmação',
        message: 'Tem certeza que deseja remover este aluno?',
      },
      breakpoints: [0, 0.3, 0.5, 0.8],
      initialBreakpoint: 0.3
    });
  
    await modal.present();
  
    const { data } = await modal.onWillDismiss();
    if (data) {
      await this.supabaseService.deleteAluno(id);
      await this.getAlunos();
      this.fecharForms();
    }
  }

  fecharForms() {
    this.novoAluno = false;
    this.editarAluno = false;
    this.aluno = {id: null || 0, nome: '', curso: ''};
    this.modalTitle = '';
  }

}
```

## Exemplo de `home.page.html`

```html
<ion-header>
  <ion-toolbar>
    <ion-title>
      Alunos
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="novoAlunoForm()">Novo</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-card>
    <ion-list *ngIf="!isLoadingAlunos">
      <ion-item-sliding *ngFor="let aluno of alunos">
        <ion-item>
          <ion-label>{{ aluno.nome }}</ion-label>
          <ion-note slot="end">{{aluno.curso}}</ion-note>
        </ion-item>
        <ion-item-options side="end">
          <ion-item-option color="warning" (click)="editarAlunoForm(aluno.id || 0)">
            <ion-label class="ion-text-center">
              <ion-icon name="create"></ion-icon>
              <div>Editar</div>
            </ion-label>
          </ion-item-option>
          <ion-item-option color="danger" (click)="removerAluno(aluno.id || 0)">
            <ion-label class="ion-text-center">
              <ion-icon name="trash"></ion-icon>
              <div>Remover</div>
            </ion-label>
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
    </ion-list>

    <ion-list *ngIf="isLoadingAlunos">
      <ion-item>
        <ion-label color="primary">A carregar alunos...</ion-label>
        <ion-spinner name="circles" color="primary"></ion-spinner>
      </ion-item>
    </ion-list>

  </ion-card>

  <ion-card *ngIf="editarAluno || novoAluno">
    <ion-card-header>
      <ion-card-subtitle>{{ modalTitle }}</ion-card-subtitle>
    </ion-card-header>
    <ion-item>
      <ion-label position="floating">Nome</ion-label>
      <ion-input [(ngModel)]="aluno.nome" required></ion-input>
    </ion-item>
    <ion-item>
      <ion-label position="floating">Curso</ion-label>
      <ion-input [(ngModel)]="aluno.curso" required></ion-input>
    </ion-item>
    <ion-item>
      <ion-button expand="full" (click)="setAluno()">Guardar</ion-button>
    </ion-item>
  </ion-card>
</ion-content>
```

---
_José Viana | josev@estg.ipvc.pt_